# Feature Specification: 数据库查询工具

**Feature Branch**: `001-db-query-tool`
**Created**: 2025-11-16
**Status**: Draft
**Input**: User description: "数据库查询工具，支持添加数据库连接、查看元数据、执行SQL查询和自然语言生成SQL"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 添加和管理数据库连接 (Priority: P1)

作为数据分析师，我需要能够添加数据库连接并查看数据库的结构信息，这样我才能了解可用的数据表和字段。

**Why this priority**: 这是系统的基础功能，没有数据库连接，后续的查询功能都无法使用。这是最小可行产品(MVP)的核心。

**Independent Test**: 可以通过添加一个PostgreSQL数据库URL，系统成功连接并显示该数据库中所有表和视图的列表来完整测试此功能。

**Acceptance Scenarios**:

1. **Given** 用户打开应用，**When** 用户输入有效的数据库连接URL（如PostgreSQL连接字符串），**Then** 系统成功建立连接并保存连接信息
2. **Given** 数据库连接已建立，**When** 系统获取数据库元数据，**Then** 显示所有表和视图的列表，包括表名、列名、数据类型等信息
3. **Given** 用户查看数据库列表，**When** 用户选择某个数据库连接，**Then** 展开显示该数据库的所有表和视图的详细结构
4. **Given** 用户有多个已保存的数据库连接，**When** 用户查看连接列表，**Then** 可以看到所有已保存的连接，并能够选择、编辑或删除它们

---

### User Story 2 - 手动SQL查询执行 (Priority: P2)

作为数据分析师，我需要能够手动编写和执行SQL查询语句，并以表格形式查看结果，这样我就能快速探索数据。

**Why this priority**: 这是核心查询功能，在P1建立连接的基础上，允许用户直接与数据库交互。这使得工具立即可用。

**Independent Test**: 可以通过在SQL编辑器中输入 `SELECT * FROM users`，点击执行，然后在界面上看到格式化的表格结果来完整测试此功能。

**Acceptance Scenarios**:

1. **Given** 用户已选择一个数据库连接，**When** 用户在SQL编辑器中输入SELECT查询语句，**Then** 提供语法高亮和自动补全功能
2. **Given** 用户输入了有效的SELECT语句，**When** 用户点击执行按钮，**Then** 系统解析并验证SQL语法，执行查询，并以表格形式展示结果
3. **Given** 用户输入的查询不包含LIMIT子句，**When** 执行查询，**Then** 系统自动添加 `LIMIT 1000` 以防止返回过多数据
4. **Given** 用户输入了包含非SELECT操作的SQL语句（如INSERT、UPDATE、DELETE），**When** 尝试执行，**Then** 系统拒绝执行并显示错误消息"仅允许SELECT查询"
5. **Given** 用户输入了语法错误的SQL语句，**When** 尝试执行，**Then** 系统显示清晰的语法错误信息，指出错误位置
6. **Given** 查询执行完成，**When** 结果显示在表格中，**Then** 显示结果行数、执行时间等元信息

---

### User Story 3 - 自然语言生成SQL (Priority: P3)

作为不熟悉SQL语法的业务分析师，我希望能够用自然语言描述我的查询需求，系统自动生成相应的SQL语句，这样我不需要学习复杂的SQL语法也能查询数据。

**Why this priority**: 这是增强功能，降低了工具的使用门槛，但不是基本功能。在P1和P2完成后，系统已经可以正常使用。

**Independent Test**: 可以通过输入自然语言"显示最近30天注册的用户"，系统生成对应的SQL语句，用户确认后执行并看到结果来完整测试此功能。

**Acceptance Scenarios**:

1. **Given** 用户已选择一个数据库连接，**When** 用户在自然语言输入框中输入查询需求（如"查找所有活跃用户"），**Then** 系统调用LLM，结合数据库元数据上下文生成相应的SQL语句
2. **Given** 系统生成了SQL语句，**When** 显示生成的SQL，**Then** 用户可以预览、编辑或直接执行该SQL语句
3. **Given** 用户对生成的SQL不满意，**When** 用户修改自然语言描述或手动调整生成的SQL，**Then** 可以重新生成或直接执行修改后的查询
4. **Given** 自然语言描述不够明确，**When** LLM无法生成合理的SQL，**Then** 系统提示用户提供更具体的描述或显示可能的解释选项

---

### User Story 4 - 查询结果导出 (Priority: P4)

作为数据分析师，我需要能够将查询结果导出为常见格式（CSV、JSON），这样我可以在其他工具中进一步分析数据。

**Why this priority**: 这是便利性功能，提升用户体验，但不影响核心查询功能的使用。

**Independent Test**: 可以通过执行一个查询，点击导出按钮，选择CSV格式，然后下载文件并在Excel中打开验证数据完整性来完整测试此功能。

**Acceptance Scenarios**:

1. **Given** 查询结果已显示在表格中，**When** 用户点击导出按钮并选择CSV格式，**Then** 系统生成CSV文件供用户下载
2. **Given** 查询结果已显示，**When** 用户选择JSON格式导出，**Then** 系统生成格式化的JSON文件
3. **Given** 结果集非常大（超过10000行），**When** 用户尝试导出，**Then** 系统提示确认或提供分批导出选项

---

### Edge Cases

- **数据库连接失败**: 当用户输入的数据库URL无效或数据库不可访问时，系统应显示明确的错误信息（连接超时、认证失败、网络错误等）
- **超大查询结果**: 当查询返回的数据量非常大时，系统应限制显示行数，并提供分页或导出选项，而不是直接加载所有数据导致浏览器崩溃
- **长时间运行的查询**: 当SQL查询执行时间过长时，系统应显示加载状态，并允许用户取消正在执行的查询
- **特殊字符和编码**: 当数据库中的数据包含特殊字符、多字节字符或null值时，系统应正确显示和处理
- **多用户并发**: 由于系统不需要认证，多个用户可能同时使用。确保数据库连接池正确管理，避免连接耗尽
- **SQL注入防护**: 虽然只允许SELECT语句，但仍需防止通过特殊构造的查询访问不应该访问的数据或执行子查询中的修改操作
- **元数据缓存过期**: 当数据库结构发生变化（新增表、修改列）后，系统应能够刷新或重新获取元数据
- **LLM服务不可用**: 当自然语言转SQL功能的LLM服务不可用时，系统应优雅降级，提示用户使用手动SQL输入

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持添加PostgreSQL数据库连接URL，并验证连接的有效性
- **FR-002**: 系统必须能够连接到PostgreSQL数据库并获取完整的元数据信息，包括表名、视图名、列名、数据类型、主键、外键关系
- **FR-003**: 系统必须将数据库连接信息和元数据持久化存储到本地SQLite数据库中
- **FR-004**: 用户必须能够查看、选择、编辑和删除已保存的数据库连接
- **FR-005**: 系统必须提供SQL编辑器，支持语法高亮、自动补全和多行编辑
- **FR-006**: 系统必须使用SQL解析器验证用户输入的SQL语句，仅允许执行SELECT查询
- **FR-007**: 系统必须自动为不包含LIMIT子句的SELECT查询添加 `LIMIT 1000`
- **FR-008**: 系统必须以表格形式展示查询结果，包括列标题、数据行和元信息（行数、执行时间）
- **FR-009**: 当SQL语句有语法错误时，系统必须显示清晰的错误消息，指出错误类型和位置
- **FR-010**: 系统必须提供自然语言输入接口，允许用户用中文或英文描述查询需求
- **FR-011**: 系统必须调用LLM服务，结合当前数据库的元数据上下文，生成相应的SQL语句
- **FR-012**: 用户必须能够预览、编辑LLM生成的SQL语句，然后决定是否执行
- **FR-013**: 系统必须支持将查询结果导出为CSV和JSON格式
- **FR-014**: 系统必须在查询执行期间显示加载状态，并提供取消查询的选项
- **FR-015**: 系统必须正确处理数据库中的特殊字符、null值和多字节字符
- **FR-016**: 用户必须能够手动刷新数据库元数据以获取最新的表结构信息

### Key Entities

- **DatabaseConnection**: 表示一个数据库连接，包含连接URL、数据库名称、连接状态、创建时间、最后使用时间等属性
- **DatabaseMetadata**: 表示数据库的元数据信息，包含数据库ID、表/视图的完整结构信息（表名、列名、数据类型、约束）、元数据获取时间
- **QueryHistory**: 表示查询历史记录，包含查询文本、执行时间、返回行数、是否成功、错误信息（如有）
- **Table/View**: 表示数据库中的表或视图，包含名称、列定义列表、表类型（表/视图）
- **Column**: 表示表中的列，包含列名、数据类型、是否可为空、是否主键、默认值等属性
- **QueryResult**: 表示查询执行结果，包含列定义、数据行、总行数、执行耗时

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在30秒内成功添加一个数据库连接并查看其表结构列表
- **SC-002**: 用户执行简单SELECT查询（如 `SELECT * FROM users LIMIT 10`）后，结果在3秒内显示
- **SC-003**: SQL语法验证能够准确识别并阻止所有非SELECT操作（INSERT、UPDATE、DELETE、DROP等），错误识别率为0%
- **SC-004**: 对于包含100-1000行结果的查询，表格渲染和交互保持流畅，不出现卡顿
- **SC-005**: 自然语言转SQL功能对于常见查询需求（过滤、排序、聚合）的准确率达到80%以上
- **SC-006**: 系统能够正确处理和显示包含特殊字符（中文、emoji、null值）的查询结果，无乱码或显示错误
- **SC-007**: 查询历史记录能够保存最近50条查询，用户可以快速重新执行历史查询
- **SC-008**: 元数据缓存在首次获取后，后续访问可以即时显示（<1秒），无需重新连接数据库
- **SC-009**: CSV导出功能对于1000行数据能够在5秒内完成导出并下载
- **SC-010**: 90%的用户能够在不阅读文档的情况下成功完成"添加连接→执行查询→查看结果"的完整流程

## Assumptions *(optional)*

- 假设用户主要使用PostgreSQL数据库，初期版本专注支持PostgreSQL
- 假设用户对SQL有基本了解，至少能够理解生成的SELECT语句
- 假设数据库服务器可以从用户网络访问，不需要VPN或代理配置
- 假设单个查询结果不会超过100,000行（通过LIMIT限制）
- 假设LLM服务（OpenAI API）始终可用且响应时间在5-10秒内
- 假设用户的数据库连接有只读权限最佳，但系统通过SQL验证确保安全
- 假设元数据信息不会频繁变化，缓存24小时后自动刷新
- 假设用户在现代浏览器（Chrome、Firefox、Safari、Edge最新版本）中使用应用

## Scope Boundaries *(optional)*

### In Scope

- PostgreSQL数据库支持
- 基本的SELECT查询执行和结果显示
- SQL语法验证和安全检查
- 自然语言转SQL（使用OpenAI LLM）
- 查询结果导出（CSV、JSON）
- 数据库元数据获取和缓存
- 查询历史记录

### Out of Scope

- 其他数据库类型（MySQL、Oracle、SQL Server）的支持（未来版本）
- 用户认证和权限管理
- 数据库写入操作（INSERT、UPDATE、DELETE）
- 复杂的数据可视化（图表、报表）
- 查询性能优化建议
- SQL查询调试和执行计划分析
- 多数据库联合查询
- 数据库备份和恢复功能
- 移动端应用支持
- 离线模式
